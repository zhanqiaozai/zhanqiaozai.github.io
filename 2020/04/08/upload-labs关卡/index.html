<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>upload-labs关卡 | 栈桥仔</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="upload-labs第一关upload-labs第一关有两种方法绕过第一种使用burpsuit 第二种F12将JS过滤源码删除 查看界面  上传php文件看看能否上传，弹出了对话框，这表名验证点在前端，而不是在服务端  代码分析判断了验证点在前端，查看JS判断代码，F12找到判断代码  把代码抠出来整理 123456789101112131415161718192021function chec">
<meta property="og:type" content="article">
<meta property="og:title" content="upload-labs关卡">
<meta property="og:url" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/index.html">
<meta property="og:site_name" content="栈桥仔">
<meta property="og:description" content="upload-labs第一关upload-labs第一关有两种方法绕过第一种使用burpsuit 第二种F12将JS过滤源码删除 查看界面  上传php文件看看能否上传，弹出了对话框，这表名验证点在前端，而不是在服务端  代码分析判断了验证点在前端，查看JS判断代码，F12找到判断代码  把代码抠出来整理 123456789101112131415161718192021function chec">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407135006062.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407135530806.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140025900.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140430474.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140524961.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140616118.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141341729.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141406254.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141521547.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141622318.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407142209535.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407142228744.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407142309837.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407143520423.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145002372.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145030124.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145105478.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145158676.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407151641458.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/1585720364221.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/1585719831410.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154104175.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154202446.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154604250.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154622841.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154646284.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154837626.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154923154.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/1585788531529.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407155130449.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/1585786793204.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407172124838.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407172944247.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407173101652.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407173907933.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174027297.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174059887.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174419725.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/C:%5CUsers%5C%E7%8A%B6%E5%85%83%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200407174444629.png">
<meta property="og:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/C:%5CUsers%5C%E7%8A%B6%E5%85%83%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200407174456829.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174734363.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174757325.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174807082.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407175030777.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407175059266.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407175128156.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407200436602.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406081237206.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083134693.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083446465.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083622923.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083751706.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083843607.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406084954651.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085245844.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085344970.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085602285.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085759324.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407210648001.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211550062.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211632706.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211720783.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211800092.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407213647598.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407213901204.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407214334480.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407214613459.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407215126253.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407222258037.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408081053635.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408085942785.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090025138.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090025138.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090541467.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090556017.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090816482.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090859802.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408091006941.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408091502290.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408091704597.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092257532.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092529967.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092612457.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092657212.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092758617.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408093537018.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408093707249.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408094417117.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408100032030.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408100802057.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408101223834.png">
<meta property="og:image" content="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408101414864.png">
<meta property="article:published_time" content="2020-04-08T05:46:26.619Z">
<meta property="article:modified_time" content="2020-04-08T05:43:28.000Z">
<meta property="article:author" content="zhanqiaozai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407135006062.png">
  
    <link rel="alternative" href="/atom.xml" title="栈桥仔" type="application/atom+xml">
  
  
    <link rel="icon" href="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 4.2.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">zhanqiaozai</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">zhanqiaozai</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">zhanqiaozai</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-upload-labs关卡" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/" class="article-date">
  	<time datetime="2020-04-08T05:46:26.619Z" itemprop="datePublished">2020-04-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      upload-labs关卡
      
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="upload-labs第一关"><a href="#upload-labs第一关" class="headerlink" title="upload-labs第一关"></a>upload-labs第一关</h4><h5 id="upload-labs第一关有两种方法绕过"><a href="#upload-labs第一关有两种方法绕过" class="headerlink" title="upload-labs第一关有两种方法绕过"></a>upload-labs第一关有两种方法绕过</h5><p>第一种使用burpsuit</p>
<p>第二种F12将JS过滤源码删除</p>
<p>查看界面</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407135006062.png" alt="image-20200407135006062"></p>
<p>上传php文件看看能否上传，弹出了对话框，这表名验证点在前端，而不是在服务端</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407135530806.png" alt="image-20200407135530806"></p>
<h5 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h5><p>判断了验证点在前端，查看JS判断代码，F12找到判断代码</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140025900.png" alt="image-20200407140025900"></p>
<p>把代码抠出来整理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function checkFile() &#123;</span><br><span class="line">    var file &#x3D; document.getElementsByName(&#39;upload_file&#39;)[0].value;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    if (file &#x3D;&#x3D; null || file &#x3D;&#x3D; &quot;&quot;) &#123;</span><br><span class="line">        alert(&quot;请选择要上传的文件!&quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;定义允许上传的文件类型</span><br><span class="line">    var allow_ext &#x3D; &quot;.jpg|.png|.gif&quot;;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;提取上传文件的类型</span><br><span class="line">    var ext_name &#x3D; file.substring(file.lastIndexOf(&quot;.&quot;));</span><br><span class="line">    &#x2F;&#x2F;判断上传文件类型是否允许上传</span><br><span class="line">    if (allow_ext.indexOf(ext_name + &quot;|&quot;) &#x3D;&#x3D; -1) &#123;</span><br><span class="line">        var errMsg &#x3D; &quot;该文件不允许上传，请上传&quot; + allow_ext + &quot;类型的文件,当前文件类型为：&quot; + ext_name;</span><br><span class="line">        alert(errMsg);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，上传之前，通过JS判断一下文件后缀是否为.jpg|.png|.gif,不是就不允许上传</p>
<h5 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h5><p>对于前端js验证的绕过方法较为简单，我们可以将要上传的php文件改后缀名为jpg|png|gif,绕过js验证后，再用burp更改上传请求。或者浏览器禁用js后进行上传</p>
<p>现将文件名改为可上传格式，使用burp抓包改为php这样就可以绕过了</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140430474.png" alt="image-20200407140430474"></p>
<p>查看页面，返回空白图片说明成功</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140524961.png" alt="image-20200407140524961"></p>
<p>查看根目录</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407140616118.png" alt="image-20200407140616118"></p>
<p>使用第二种方法，删除检查源码进行上传</p>
<p>按F12打开源码</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141341729.png" alt="image-20200407141341729"></p>
<p>删除红线处的内容onsubmit</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141406254.png" alt="image-20200407141406254"></p>
<p>提交内容，页面返回空白说明正确</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141521547.png" alt="image-20200407141521547"></p>
<p>查看根目录</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407141622318.png" alt="image-20200407141622318"></p>
<p>可以使用菜刀连接</p>
<h4 id="upload-labs第二关"><a href="#upload-labs第二关" class="headerlink" title="upload-labs第二关"></a>upload-labs第二关</h4><h5 id="查看代码"><a href="#查看代码" class="headerlink" title="查看代码"></a>查看代码</h5><p>这里只对Content-type进行了检查，只有当Content-type等于image/jpeg等格式才能上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line"></span><br><span class="line">        if (($_FILES[&#39;upload_file&#39;][&#39;type&#39;] &#x3D;&#x3D; &#39;image&#x2F;jpeg&#39;) || ($_FILES[&#39;upload_file&#39;][&#39;type&#39;] &#x3D;&#x3D; &#39;image&#x2F;png&#39;) || ($_FILES[&#39;upload_file&#39;][&#39;type&#39;] &#x3D;&#x3D; &#39;image&#x2F;gif&#39;)) &#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR . $_FILES[&#39;upload_file&#39;][&#39;name&#39;];</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;文件类型不正确，请重新上传！&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR.&#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h5><p>使用burp抓包，更改Content-type的值</p>
<p>上传php文件Content-type的值是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: application&#x2F;octet-stream</span><br></pre></td></tr></table></figure>

<p>需要将Content-Type中的值改为image/jpeg等可以上传的格式</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407142209535.png" alt="image-20200407142209535"></p>
<p>查看页面，页面返回空白，说明上传成功</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407142228744.png" alt="image-20200407142228744"></p>
<p>查看根目录</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407142309837.png" alt="image-20200407142309837"></p>
<p>可以使用菜刀连接</p>
<h4 id="upload-labs第三关"><a href="#upload-labs第三关" class="headerlink" title="upload-labs第三关"></a>upload-labs第三关</h4><h5 id="查看源代码"><a href="#查看源代码" class="headerlink" title="查看源代码"></a>查看源代码</h5><p>可以看到服务器做了一个黑名单验证过滤了’.asp’,’.aspx’,’.php’,’.jsp’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line"></span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&#39;.asp&#39;,&#39;.aspx&#39;,&#39;.php&#39;,&#39;.jsp&#39;);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_name &#x3D; deldot($file_name);&#x2F;&#x2F;删除文件名末尾的点</span><br><span class="line">        $file_ext &#x3D; strrchr($file_name, &#39;.&#39;);</span><br><span class="line">        $file_ext &#x3D; strtolower($file_ext); &#x2F;&#x2F;转换为小写</span><br><span class="line">        $file_ext &#x3D; str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);&#x2F;&#x2F;去除字符串::$DATA</span><br><span class="line">        $file_ext &#x3D; trim($file_ext); &#x2F;&#x2F;收尾去空</span><br><span class="line"></span><br><span class="line">        if(!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR. &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                 $img_path &#x3D; $UPLOAD_ADDR .&#39;&#x2F;&#39;. $_FILES[&#39;upload_file&#39;][&#39;name&#39;];</span><br><span class="line">                 $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="绕过方法-2"><a href="#绕过方法-2" class="headerlink" title="绕过方法"></a>绕过方法</h5><p>不允许上传.asp,.aspx,.php,.jsp后缀文件，但是可以上传其他的任意后缀名的文件，比如说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.phtml .phps .php4 .php3</span><br></pre></td></tr></table></figure>

<p>这里黑名单也没有过滤.htaccess，所以也可上传.htaccess后缀的文件进行绕过。</p>
<h6 id="注-htaccess文件生效前提条件为1-mod-rewrite模块开启。2-AllowOverride-All"><a href="#注-htaccess文件生效前提条件为1-mod-rewrite模块开启。2-AllowOverride-All" class="headerlink" title="注: .htaccess文件生效前提条件为1.mod_rewrite模块开启。2.AllowOverride All"></a><em>注: .htaccess文件生效前提条件为1.mod_rewrite模块开启。2.AllowOverride All</em></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能IIS平台上不存在该文件，该文件默认开启，启用和关闭在httpd.conf文件中配置。</span><br></pre></td></tr></table></figure>

<h5 id="配置文件http-conf"><a href="#配置文件http-conf" class="headerlink" title="配置文件http.conf"></a>配置文件http.conf</h5><p>在Apache中如果需要启动.htaccess，必须在http.conf中设置 AllowOverride</p>
<p>默认情况下红框内会出现None，将None修改为All</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407143520423.png" alt="image-20200407143520423"></p>
<p>这里绕过不使用.htaccess但是提前配置好，使用其他的几个没过滤的文件后缀</p>
<p>使用一下其中一个，当然不止这些扩展名，还有很多</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.phtml .phps .php4 .php3</span><br></pre></td></tr></table></figure>

<p>上传php文件使用burp抓包</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145002372.png" alt="image-20200407145002372"></p>
<p>将shell.php改为shell.phps</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145030124.png" alt="image-20200407145030124"></p>
<p>Forward放行，页面返回空白图片</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145105478.png" alt="image-20200407145105478"></p>
<p>右键选择复制图片地址在浏览器中打开，成功返回结果</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407145158676.png" alt="image-20200407145158676"></p>
<h4 id="upload-labs第四关"><a href="#upload-labs第四关" class="headerlink" title="upload-labs第四关"></a>upload-labs第四关</h4><h5 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h5><p>可以看到，黑名单里php、php3等这种后缀全部不允许上传，但并没有限制.htaccsess文件。故可以上传.htaccsess文件绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;php1&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;pHp1&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;);</span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_name &#x3D; deldot($file_name);&#x2F;&#x2F;删除文件名末尾的点</span><br><span class="line">        $file_ext &#x3D; strrchr($file_name, &#39;.&#39;);</span><br><span class="line">        $file_ext &#x3D; strtolower($file_ext); &#x2F;&#x2F;转换为小写</span><br><span class="line">        $file_ext &#x3D; str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);&#x2F;&#x2F;去除字符串::$DATA</span><br><span class="line">        $file_ext &#x3D; trim($file_ext); &#x2F;&#x2F;收尾去空</span><br><span class="line"></span><br><span class="line">        if (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR . $_FILES[&#39;upload_file&#39;][&#39;name&#39;];</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;此文件不允许上传!&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在桌面你新建一个one.txt，里面写入SetHandler application/x-httpd-php内容另存为.htaccess</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/upload%5Cimage-20200407151641458.png" alt="image-20200407151641458"></p>
<p>页面进行上传，会返回一个空图片</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/1585720364221.png" alt="1585719758584"></p>
<p>复制图片链接，打开新的网址，会出现403，会显示</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/1585719831410.png" alt="1585719740191"></p>
<p>这说明你文件已经上传了，但是你没有权限去访问他</p>
<p>在上传一个图片，图片包含phpinfo探针</p>
<p>使用文本编写php代码</p>
<?php 

​    phpinfo();

?>

<p>保存为1.jpg进行上传</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154104175.png" alt="image-20200407154104175"></p>
<p>复制图片地址在浏览器中打开</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154202446.png" alt="image-20200407154202446"></p>
<h4 id="upload-labs第五关"><a href="#upload-labs第五关" class="headerlink" title="upload-labs第五关"></a>upload-labs第五关</h4><h5 id="代码分析-2"><a href="#代码分析-2" class="headerlink" title="代码分析"></a>代码分析</h5><p>可以看到，此处的黑名单比Pass-04多了.htaccess，所有不能通过.htaccsess进行绕过了。但此处代码没有将文件名统一转成小写，可以通过大小写绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);</span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_name &#x3D; deldot($file_name);&#x2F;&#x2F;删除文件名末尾的点</span><br><span class="line">        $file_ext &#x3D; strrchr($file_name, &#39;.&#39;);</span><br><span class="line">        $file_ext &#x3D; str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);&#x2F;&#x2F;去除字符串::$DATA</span><br><span class="line">        $file_ext &#x3D; trim($file_ext); &#x2F;&#x2F;首尾去空</span><br><span class="line"></span><br><span class="line">        if (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; . $file_name;</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;此文件不允许上传&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="绕过方法-3"><a href="#绕过方法-3" class="headerlink" title="绕过方法"></a>绕过方法</h5><p>用burp将后缀改为大写PHP即可</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154604250.png" alt="image-20200407154604250"></p>
<p>放行查看页面</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154622841.png" alt="image-20200407154622841"></p>
<p>查看根目录</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154646284.png" alt="image-20200407154646284"></p>
<h4 id="WebaCoo上传Webshell"><a href="#WebaCoo上传Webshell" class="headerlink" title="WebaCoo上传Webshell"></a>WebaCoo上传Webshell</h4><p>WebaCoo生成Webshell：webacoo -g -o a.php</p>
<p>上传Webshell</p>
<p>连接Webshell：webacoo -t -u Webshell地址</p>
<h5 id="在kali中使用webacoo新建一个a-php文件"><a href="#在kali中使用webacoo新建一个a-php文件" class="headerlink" title="在kali中使用webacoo新建一个a.php文件"></a>在kali中使用webacoo新建一个a.php文件</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154837626.png" alt="image-20200407154837626"></p>
<p>将文件复制到本地文件中，将后缀名改为大小写结合的PhP</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407154923154.png" alt="image-20200407154923154"></p>
<p>上传复制会返回空白图片，复制图片连接，在另一个页面打开这个地址</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/1585788531529.png" alt="1585786501683"></p>
<p>复制这个地址去kali连接webshell，使用webacoo -t -u “URL”命令</p>
<p>注意：在URL中，因为是从本地copy到kali中的，本地的靶场是127.0.0.1，但在kali中没有127.0.0.1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webacoo -t -u &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;upload-labs&#x2F;upload&#x2F;a.PhP&quot;</span><br></pre></td></tr></table></figure>

<p>我们需要修改成本地地址<br>打开cmd使用ipconfig查看当前地址，将127.0.0.1改为当前地址，出现这个页面就说明连接成功</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407155130449.png" alt="image-20200407155130449"></p>
<p>使用ipconfig可以查看本地ip等等</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/1585786793204.png" alt="1585786724856"></p>
<h4 id="upload-labs第六关"><a href="#upload-labs第六关" class="headerlink" title="upload-labs第六关"></a>upload-labs第六关</h4><h5 id="代码分析-3"><a href="#代码分析-3" class="headerlink" title="代码分析"></a>代码分析</h5><p>可以看到，相比于上面Pass-05代码，这里将文件后缀名统一进行了小写转换，但是没有去除文件名首尾的空格。所以此处可以利用windows系统的命名规则进行绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);</span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_name &#x3D; deldot($file_name);&#x2F;&#x2F;删除文件名末尾的点</span><br><span class="line">        $file_ext &#x3D; strrchr($file_name, &#39;.&#39;);</span><br><span class="line">        $file_ext &#x3D; strtolower($file_ext); &#x2F;&#x2F;转换为小写</span><br><span class="line">        $file_ext &#x3D; str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);&#x2F;&#x2F;去除字符串::$DATA</span><br><span class="line">        </span><br><span class="line">        if (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; . $file_name;</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;此文件不允许上传&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为Windows特性所以不能在Windows下加空格，在kali中加入空格</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407172124838.png" alt="image-20200407172124838"></p>
<p>进行上传，页面返回空白</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407172944247.png" alt="image-20200407172944247"></p>
<p>查看根目录</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407173101652.png" alt="image-20200407173101652"></p>
<h4 id="upload-labs第七关"><a href="#upload-labs第七关" class="headerlink" title="upload-labs第七关"></a>upload-labs第七关</h4><h5 id="代码分析-4"><a href="#代码分析-4" class="headerlink" title="代码分析"></a>代码分析</h5><p>从代码上看，可以发现相比于Pass-06代码，加上了首尾去空，但是却少了尾部去点。故和上面Pass-06一样，利用windows文件命名规则绕过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);</span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_ext &#x3D; strrchr($file_name, &#39;.&#39;);</span><br><span class="line">        $file_ext &#x3D; strtolower($file_ext); &#x2F;&#x2F;转换为小写</span><br><span class="line">        $file_ext &#x3D; str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);&#x2F;&#x2F;去除字符串::$DATA</span><br><span class="line">        $file_ext &#x3D; trim($file_ext); &#x2F;&#x2F;首尾去空</span><br><span class="line">        </span><br><span class="line">        if (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; . $file_name;</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;此文件不允许上传&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在php后面加一个.</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407173907933.png" alt="image-20200407173907933"></p>
<p>上传，并查看</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174027297.png" alt="image-20200407174027297"></p>
<p>查看根目录</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174059887.png" alt="image-20200407174059887"></p>
<h4 id="upload-labs第八关"><a href="#upload-labs第八关" class="headerlink" title="upload-labs第八关"></a>upload-labs第八关</h4><h5 id="代码分析-5"><a href="#代码分析-5" class="headerlink" title="代码分析"></a>代码分析</h5><p>可以看到，与前面第七关的代码相比，少了去除文件名的”::$DATA”字符串这一步。这里还是利用windows的一个特性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);</span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_name &#x3D; deldot($file_name);&#x2F;&#x2F;删除文件名末尾的点</span><br><span class="line">        $file_ext &#x3D; strrchr($file_name, &#39;.&#39;);</span><br><span class="line">        $file_ext &#x3D; strtolower($file_ext); &#x2F;&#x2F;转换为小写</span><br><span class="line">        $file_ext &#x3D; trim($file_ext); &#x2F;&#x2F;首尾去空</span><br><span class="line">        </span><br><span class="line">        if (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; . $file_name;</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;此文件不允许上传&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NTFS文件系统包括对备用数据流的支持。这不是众所周知的功能，主要包括提供与Macintosh文件系统中的文件的兼容性。备用数据流允许文件包含多个数据流。每个文件至少有一个数据流。在Windows中，此默认数据流称为：$ DATA。</p>
<p>简单讲就是在php+windows的情况下：如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名。</p>
<p><em>注:仅windows适用</em></p>
<h5 id="更改文件名"><a href="#更改文件名" class="headerlink" title="更改文件名"></a>更改文件名</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174419725.png" alt="image-20200407174419725"></p>
<p>上传</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/C:%5CUsers%5C%E7%8A%B6%E5%85%83%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200407174444629.png" alt="image-20200407174444629"></p>
<p>查看根目录</p>
<p><img src="/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/C:%5CUsers%5C%E7%8A%B6%E5%85%83%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200407174456829.png" alt="image-20200407174456829"></p>
<h4 id="upload-labs第九关"><a href="#upload-labs第九关" class="headerlink" title="upload-labs第九关"></a>upload-labs第九关</h4><h5 id="代码分析-6"><a href="#代码分析-6" class="headerlink" title="代码分析"></a>代码分析</h5><p>可以看到，这里代码的安全性比之前的都要更高，黑名单类型全，大小写经过转换，去除了文件名末尾的点，去除了文件名尾空格，还去除了::$DATA。。但是，这里还是可以绕过的。<strong>这里的代码逻辑是先删除文件名末尾的点，再进行首尾去空。</strong>都只进行一次。故可以构造点空格点进行绕过，也就是后缀名改为<code>xx.php. .</code>，也是利用了Windows的特性。<br> 也就是说，如果从第三关到第九关，如果目标服务器是windows系统的话，均可用点空格点绕过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);</span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_name &#x3D; deldot($file_name);&#x2F;&#x2F;删除文件名末尾的点</span><br><span class="line">        $file_ext &#x3D; strrchr($file_name, &#39;.&#39;);</span><br><span class="line">        $file_ext &#x3D; strtolower($file_ext); &#x2F;&#x2F;转换为小写</span><br><span class="line">        $file_ext &#x3D; str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);&#x2F;&#x2F;去除字符串::$DATA</span><br><span class="line">        $file_ext &#x3D; trim($file_ext); &#x2F;&#x2F;首尾去空</span><br><span class="line">        </span><br><span class="line">        if (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;])) &#123;</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; . $file_name;</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg &#x3D; &#39;此文件不允许上传&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更改文件名</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174734363.png" alt="image-20200407174734363"></p>
<p>上传，返回空白图片</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174757325.png" alt="image-20200407174757325"></p>
<p>查看根目录</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407174807082.png" alt="image-20200407174807082"></p>
<h4 id="upload-labs第十关"><a href="#upload-labs第十关" class="headerlink" title="upload-labs第十关"></a>upload-labs第十关</h4><h5 id="代码分析-7"><a href="#代码分析-7" class="headerlink" title="代码分析"></a>代码分析</h5><p>这里代码没有了之前关卡里的去除文件尾点、空格、::$DATA的操作，估计是针对非Windows系统的。这里存在的问题是，利用str_ireplace对黑名单里的文件后缀名进行了替换，换成空字符，使用了str_ireplace函数，即不区分大小写，故大小写绕过不适用。但是这里替换是替换成了空字符，于是我们可以双写后缀名，如<code>.pphphp</code>,使得替换后的后缀名为php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;php&quot;,&quot;php5&quot;,&quot;php4&quot;,&quot;php3&quot;,&quot;php2&quot;,&quot;html&quot;,&quot;htm&quot;,&quot;phtml&quot;,&quot;jsp&quot;,&quot;jspa&quot;,&quot;jspx&quot;,&quot;jsw&quot;,&quot;jsv&quot;,&quot;jspf&quot;,&quot;jtml&quot;,&quot;asp&quot;,&quot;aspx&quot;,&quot;asa&quot;,&quot;asax&quot;,&quot;ascx&quot;,&quot;ashx&quot;,&quot;asmx&quot;,&quot;cer&quot;,&quot;swf&quot;,&quot;htaccess&quot;);</span><br><span class="line"></span><br><span class="line">        $file_name &#x3D; trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);</span><br><span class="line">        $file_name &#x3D; str_ireplace($deny_ext,&quot;&quot;, $file_name);</span><br><span class="line">        if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $UPLOAD_ADDR . &#39;&#x2F;&#39; . $file_name)) &#123;</span><br><span class="line">            $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; .$file_name;</span><br><span class="line">            $is_upload &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更改文件后缀名</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407175030777.png" alt="image-20200407175030777"></p>
<p>上传文件，返回空白图片</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407175059266.png" alt="image-20200407175059266"></p>
<p>查看根目录</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407175128156.png" alt="image-20200407175128156"></p>
<h4 id="upload-labs第十一关"><a href="#upload-labs第十一关" class="headerlink" title="upload-labs第十一关"></a>upload-labs第十一关</h4><h5 id="代码分析-8"><a href="#代码分析-8" class="headerlink" title="代码分析"></a>代码分析</h5><p>这里与之前代码相比，使用了白名单，只允许上传，jpg，png，gif三种格式文件。</p>
<p>0x00是十六进制表示方法，是ascii码为0的字符，在有些和函数处理时，会把这个字符当做结束符</p>
<p>系统在对文件名的读取时，如果遇到0x00，就会认为读取已结束</p>
<p>date()随机数和rand()时间，以及最后添加文件扩展名$file_ext，这样就可以在date(“YmdHis”)后面加入0x00截断，使$file_ext被添加的文件后缀名不会被执行成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if(isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">    $ext_arr &#x3D; array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);</span><br><span class="line">    $file_ext &#x3D; substr($_FILES[&#39;upload_file&#39;][&#39;name&#39;],strrpos($_FILES[&#39;upload_file&#39;][&#39;name&#39;],&quot;.&quot;)+1);</span><br><span class="line">    if(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];</span><br><span class="line">        $img_path &#x3D; $_GET[&#39;save_path&#39;].&quot;&#x2F;&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br><span class="line"></span><br><span class="line">        if(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $msg &#x3D; &#39;上传失败！&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        $msg &#x3D; &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">截断条件：</span><br><span class="line"> 1、php版本小于5.3.4</span><br><span class="line"> 2、php.ini的magic_quotes_gpc为OFF状态</span><br></pre></td></tr></table></figure>

<p>将其改为OFF状态</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407200436602.png" alt="image-20200407200436602"></p>
<p>首先新建一个1.php的文件，将其里面写入一句话木马</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406081237206.png" alt="image-20200406083446465"></p>
<p>写入一句话木马后，在将文件改名为1.jpg或者png只要是允许上传的文件格式就可以</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083134693.png" alt="image-20200406081237206"></p>
<p>进行上传，使用burp抓包，然后将burp中的信息进行稍微修改</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083446465.png" alt="image-20200406083134693"></p>
<p>修改完成后运行包通过，页面会返回空白图片，右击点击图片地址。</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083622923.png" alt="image-20200406083622923"></p>
<p>在新的页面将地址粘贴，粘贴完不能直接执行，需要将红线处的内容删除，也就是1.php后的内容删除，否则报错</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083751706.png" alt="image-20200406084954651"></p>
<p>删除之后在进入页面，返回phpinof的页面</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406083843607.png" alt="image-20200406085245844"></p>
<p>这就是GTE截断。</p>
<h4 id="upload-labs第十二关"><a href="#upload-labs第十二关" class="headerlink" title="upload-labs第十二关"></a>upload-labs第十二关</h4><h5 id="代码分析-9"><a href="#代码分析-9" class="headerlink" title="代码分析"></a>代码分析</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if(isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">    $ext_arr &#x3D; array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);</span><br><span class="line">    $file_ext &#x3D; substr($_FILES[&#39;upload_file&#39;][&#39;name&#39;],strrpos($_FILES[&#39;upload_file&#39;][&#39;name&#39;],&quot;.&quot;)+1);</span><br><span class="line">    if(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];</span><br><span class="line">        $img_path &#x3D; $_POST[&#39;save_path&#39;].&quot;&#x2F;&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br><span class="line"></span><br><span class="line">        if(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $msg &#x3D; &quot;上传失败&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        $msg &#x3D; &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在POST请求中，%00不会被自动解码，需要在16进制中进行修改00</p>
<p>创建一个php文件，写入一句话木马，然后更改为可上传格式，进行上传burp抓包</p>
<p>这里加入空格的原因是因为%00不会被自动解码，需要在16进制中修改，因为加入空格已知他是16进制的20，所以在HEX只需要找到位置将20修改为00就可以截断</p>
<p>这里代码与上面Pass-11代码类似，不过是save_path参数由GET传入变为POST传入，利用原理也是00截断</p>
<p>为了绕过类似的MIME Sniff的功能，常见的攻击技巧是伪造一个合法的文件头，而将真实的PHP等脚本代码附在合法的文件头之后</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406084954651.png" alt="image-20200406083751706"></p>
<p>在HEX子模块中找到1.php空格，找到20</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085245844.png" alt="image-20200406083843607"></p>
<p>找到20之后，要将他修改为00</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085344970.png" alt="image-20200406085759324"></p>
<p>修改执行点击forward进行上传，返回一个空白图片，右键复制图片连接</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085602285.png" alt="image-20200406085602285"></p>
<p>在新的浏览器打开，当然还是需要将php格式后面的删除，成功访问</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200406085759324.png" alt="image-20200406085344970"></p>
<p><strong>注意：</strong>截断需要关闭GPC否则会上传失败</p>
<h4 id="upload-labs第十三关"><a href="#upload-labs第十三关" class="headerlink" title="upload-labs第十三关"></a>upload-labs第十三关</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gif文件头表示GIF89a</span><br><span class="line"></span><br><span class="line">png文件头标识 (8 bytes) 89 50 4e 47 0d 0a 1a 0a</span><br><span class="line"></span><br><span class="line">jpg文件头标识 (2 bytes): ff, d8</span><br></pre></td></tr></table></figure>

<h5 id="代码分析-10"><a href="#代码分析-10" class="headerlink" title="代码分析"></a>代码分析</h5><p>这里代码意思是，将上传的文件读取先读取两字节，通过对比文件头来确认文件类型。<br> 于是就可以制作图片马，将php语句隐藏在图片中，然后结合文件包含漏洞执行php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">function getReailFileType($filename)&#123;</span><br><span class="line">    $file &#x3D; fopen($filename, &quot;rb&quot;);</span><br><span class="line">    $bin &#x3D; fread($file, 2); &#x2F;&#x2F;只读2字节</span><br><span class="line">    fclose($file);</span><br><span class="line">    $strInfo &#x3D; @unpack(&quot;C2chars&quot;, $bin);    </span><br><span class="line">    $typeCode &#x3D; intval($strInfo[&#39;chars1&#39;].$strInfo[&#39;chars2&#39;]);    </span><br><span class="line">    $fileType &#x3D; &#39;&#39;;    </span><br><span class="line">    switch($typeCode)&#123;      </span><br><span class="line">        case 255216:            </span><br><span class="line">            $fileType &#x3D; &#39;jpg&#39;;</span><br><span class="line">            break;</span><br><span class="line">        case 13780:            </span><br><span class="line">            $fileType &#x3D; &#39;png&#39;;</span><br><span class="line">            break;        </span><br><span class="line">        case 7173:            </span><br><span class="line">            $fileType &#x3D; &#39;gif&#39;;</span><br><span class="line">            break;</span><br><span class="line">        default:            </span><br><span class="line">            $fileType &#x3D; &#39;unknown&#39;;</span><br><span class="line">        &#125;    </span><br><span class="line">        return $fileType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if(isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">    $temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];</span><br><span class="line">    $file_type &#x3D; getReailFileType($temp_file);</span><br><span class="line"></span><br><span class="line">    if($file_type &#x3D;&#x3D; &#39;unknown&#39;)&#123;</span><br><span class="line">        $msg &#x3D; &quot;文件未知，上传失败！&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $img_path &#x3D; $UPLOAD_ADDR.&quot;&#x2F;&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_type;</span><br><span class="line">        if(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $msg &#x3D; &quot;上传失败&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这一关开始上传图片马，结合文件包含进行攻击。</p>
<p>查看提示</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407210648001.png" alt="image-20200407210648001"></p>
<h5 id="绕过方法-4"><a href="#绕过方法-4" class="headerlink" title="绕过方法"></a>绕过方法</h5><ul>
<li>服务端检测文件头，并将上传文件的后缀重命名为检测到的文件类型</li>
<li>关于服务端检测文件头，我们可以在文件起始加入<code>jpg|png|gif</code>文件的文件头来绕过</li>
</ul>
<blockquote>
<p>十进制转十六进制: <code>gif</code>为47 49 ， <code>png</code>为89 50， <code>jpg</code>为ff d8</p>
</blockquote>
<ul>
<li>关于文件上传后被重命名为图片文件，不能当做<code>php</code>解析，我们可以利用文件包含漏洞</li>
</ul>
<p>这里使用GIF</p>
<ul>
<li>gif文件头为GIF89a</li>
</ul>
<p>构造代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">&lt;?php</span><br><span class="line">	phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211550062.png" alt="image-20200407211550062"></p>
<p>将php改为jpg或者gif等能上传的格式，这里改为png</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211632706.png" alt="image-20200407211632706"></p>
<p>上传图片，页面返回空白</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211720783.png" alt="image-20200407211720783"></p>
<p>直接复制图片地址是会出错的</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407211800092.png" alt="image-20200407211800092"></p>
<p>所以需要使用到文件包含漏洞</p>
<p>在upload下新建一个php文件</p>
<p>写入简单的提交页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$file&#x3D;$_GET[&#39;ccc&#39;];</span><br><span class="line">	include($file);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407213647598.png" alt="image-20200407213647598"></p>
<p>返回页面，复制图片地址，因为我们之前新建的php文件是c.php，提交内容是ccc，所以在页面中输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;upload-labs&#x2F;upload&#x2F;c.php?ccc&#x3D;图片名称</span><br></pre></td></tr></table></figure>

<p>上传成功</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407213901204.png" alt="image-20200407213901204"></p>
<h4 id="upload-labs第十四关"><a href="#upload-labs第十四关" class="headerlink" title="upload-labs第十四关"></a>upload-labs第十四关</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">想要提交那种文件就将文件头标识放到php文本开头</span><br><span class="line"></span><br><span class="line">gif文件头表示GIF89a</span><br><span class="line"></span><br><span class="line">png文件头标识 (8 bytes) 89 50 4e 47 0d 0a 1a 0a</span><br><span class="line"></span><br><span class="line">jpg文件头标识 (2 bytes): ff, d8</span><br></pre></td></tr></table></figure>

<h5 id="查看提示"><a href="#查看提示" class="headerlink" title="查看提示"></a>查看提示</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407214334480.png" alt="image-20200407214334480"></p>
<h5 id="代码分析-11"><a href="#代码分析-11" class="headerlink" title="代码分析"></a>代码分析</h5><p>getimagesize() 函数用于获取图像大小及相关信息，成功返回一个数组，失败则返回 FALSE 并产生一条 E_WARNING 级的错误信息。</p>
<p>getimagesize() 函数将测定任何 GIF，JPG，PNG，SWF，SWC，PSD，TIFF，BMP，IFF，JP2，JPX，JB2，JPC，XBM 或 WBMP 图像文件的大小并返回图像的尺寸以及文件类型及图片高度与宽度。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function isImage($filename)&#123;</span><br><span class="line">    $types &#x3D; &#39;.jpeg|.png|.gif&#39;;</span><br><span class="line">    if(file_exists($filename))&#123;</span><br><span class="line">        $info &#x3D; getimagesize($filename);</span><br><span class="line">        $ext &#x3D; image_type_to_extension($info[2]);</span><br><span class="line">        if(stripos($types,$ext))&#123;</span><br><span class="line">            return $ext;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if(isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">    $temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];</span><br><span class="line">    $res &#x3D; isImage($temp_file);</span><br><span class="line">    if(!$res)&#123;</span><br><span class="line">        $msg &#x3D; &quot;文件未知，上传失败！&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $img_path &#x3D; $UPLOAD_ADDR.&quot;&#x2F;&quot;.rand(10, 99).date(&quot;YmdHis&quot;).$res;</span><br><span class="line">        if(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $msg &#x3D; &quot;上传失败&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="和上一关相同，只是函数换了一个"><a href="#和上一关相同，只是函数换了一个" class="headerlink" title="和上一关相同，只是函数换了一个"></a>和上一关相同，只是函数换了一个</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407214613459.png" alt="image-20200407214613459"></p>
<h4 id="upload-labs第十五关"><a href="#upload-labs第十五关" class="headerlink" title="upload-labs第十五关"></a>upload-labs第十五关</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">想要提交那种文件就将文件头标识放到php文本开头</span><br><span class="line"></span><br><span class="line">gif文件头表示GIF89a</span><br><span class="line"></span><br><span class="line">png文件头标识 (8 bytes) 89 50 4e 47 0d 0a 1a 0a</span><br><span class="line"></span><br><span class="line">jpg文件头标识 (2 bytes): ff, d8</span><br></pre></td></tr></table></figure>

<h5 id="查看提示-1"><a href="#查看提示-1" class="headerlink" title="查看提示"></a>查看提示</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407215126253.png" alt="image-20200407215126253"></p>
<h5 id="代码分析-12"><a href="#代码分析-12" class="headerlink" title="代码分析"></a>代码分析</h5><p>这里使用了<code>exif_imagetype()</code>函数</p>
<p><code>exif_imagetype()</code>函数是php内置函数，用来获取图片类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">function isImage($filename)&#123;</span><br><span class="line">    &#x2F;&#x2F;需要开启php_exif模块</span><br><span class="line">    $image_type &#x3D; exif_imagetype($filename);</span><br><span class="line">    switch ($image_type) &#123;</span><br><span class="line">        case IMAGETYPE_GIF:</span><br><span class="line">            return &quot;gif&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case IMAGETYPE_JPEG:</span><br><span class="line">            return &quot;jpg&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case IMAGETYPE_PNG:</span><br><span class="line">            return &quot;png&quot;;</span><br><span class="line">            break;    </span><br><span class="line">        default:</span><br><span class="line">            return false;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if(isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">    $temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];</span><br><span class="line">    $res &#x3D; isImage($temp_file);</span><br><span class="line">    if(!$res)&#123;</span><br><span class="line">        $msg &#x3D; &quot;文件未知，上传失败！&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $img_path &#x3D; $UPLOAD_ADDR.&quot;&#x2F;&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$res;</span><br><span class="line">        if(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $msg &#x3D; &quot;上传失败&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="和上一关一样"><a href="#和上一关一样" class="headerlink" title="和上一关一样"></a>和上一关一样</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200407222258037.png" alt="image-20200407222258037"></p>
<h4 id="upload-labs第十六关"><a href="#upload-labs第十六关" class="headerlink" title="upload-labs第十六关"></a>upload-labs第十六关</h4><h5 id="查看提示-2"><a href="#查看提示-2" class="headerlink" title="查看提示"></a>查看提示</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408081053635.png" alt="image-20200408081053635"></p>
<h5 id="代码分析-13"><a href="#代码分析-13" class="headerlink" title="代码分析"></a>代码分析</h5><p>程序通过imagecreatefromjpeg()函数调用了PHP的GD库(GD库，是php处理图形的扩展库)，对图片进行了转换。</p>
<p>将一个正常显示的图片，上传到服务器。下载被渲染后与原始图片对比，在仍然相同的数据块部分插入WebShell代码，进行上传。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">    &#x2F;&#x2F; 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span><br><span class="line">    $filename &#x3D; $_FILES[&#39;upload_file&#39;][&#39;name&#39;];</span><br><span class="line">    $filetype &#x3D; $_FILES[&#39;upload_file&#39;][&#39;type&#39;];</span><br><span class="line">    $tmpname &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];</span><br><span class="line"></span><br><span class="line">    $target_path&#x3D;$UPLOAD_ADDR.basename($filename);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 获得上传文件的扩展名</span><br><span class="line">    $fileext&#x3D; substr(strrchr($filename,&quot;.&quot;),1);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;判断文件后缀与类型，合法才进行上传操作</span><br><span class="line">    if(($fileext &#x3D;&#x3D; &quot;jpg&quot;) &amp;&amp; ($filetype&#x3D;&#x3D;&quot;image&#x2F;jpeg&quot;))&#123;</span><br><span class="line">        if(move_uploaded_file($tmpname,$target_path))</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;使用上传的图片生成新的图片</span><br><span class="line">            $im &#x3D; imagecreatefromjpeg($target_path);</span><br><span class="line"></span><br><span class="line">            if($im &#x3D;&#x3D; false)&#123;</span><br><span class="line">                $msg &#x3D; &quot;该文件不是jpg格式的图片！&quot;;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                &#x2F;&#x2F;给新图片指定文件名</span><br><span class="line">                srand(time());</span><br><span class="line">                $newfilename &#x3D; strval(rand()).&quot;.jpg&quot;;</span><br><span class="line">                $newimagepath &#x3D; $UPLOAD_ADDR.$newfilename;</span><br><span class="line">                imagejpeg($im,$newimagepath);</span><br><span class="line">                &#x2F;&#x2F;显示二次渲染后的图片（使用用户上传图片生成的新图片）</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR.$newfilename;</span><br><span class="line">                unlink($target_path);</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            $msg &#x3D; &quot;上传失败！&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;else if(($fileext &#x3D;&#x3D; &quot;png&quot;) &amp;&amp; ($filetype&#x3D;&#x3D;&quot;image&#x2F;png&quot;))&#123;</span><br><span class="line">        if(move_uploaded_file($tmpname,$target_path))</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;使用上传的图片生成新的图片</span><br><span class="line">            $im &#x3D; imagecreatefrompng($target_path);</span><br><span class="line"></span><br><span class="line">            if($im &#x3D;&#x3D; false)&#123;</span><br><span class="line">                $msg &#x3D; &quot;该文件不是png格式的图片！&quot;;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                 &#x2F;&#x2F;给新图片指定文件名</span><br><span class="line">                srand(time());</span><br><span class="line">                $newfilename &#x3D; strval(rand()).&quot;.png&quot;;</span><br><span class="line">                $newimagepath &#x3D; $UPLOAD_ADDR.$newfilename;</span><br><span class="line">                imagepng($im,$newimagepath);</span><br><span class="line">                &#x2F;&#x2F;显示二次渲染后的图片（使用用户上传图片生成的新图片）</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR.$newfilename;</span><br><span class="line">                unlink($target_path);</span><br><span class="line">                $is_upload &#x3D; true;               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            $msg &#x3D; &quot;上传失败！&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;else if(($fileext &#x3D;&#x3D; &quot;gif&quot;) &amp;&amp; ($filetype&#x3D;&#x3D;&quot;image&#x2F;gif&quot;))&#123;</span><br><span class="line">        if(move_uploaded_file($tmpname,$target_path))</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;使用上传的图片生成新的图片</span><br><span class="line">            $im &#x3D; imagecreatefromgif($target_path);</span><br><span class="line">            if($im &#x3D;&#x3D; false)&#123;</span><br><span class="line">                $msg &#x3D; &quot;该文件不是gif格式的图片！&quot;;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                &#x2F;&#x2F;给新图片指定文件名</span><br><span class="line">                srand(time());</span><br><span class="line">                $newfilename &#x3D; strval(rand()).&quot;.gif&quot;;</span><br><span class="line">                $newimagepath &#x3D; $UPLOAD_ADDR.$newfilename;</span><br><span class="line">                imagegif($im,$newimagepath);</span><br><span class="line">                &#x2F;&#x2F;显示二次渲染后的图片（使用用户上传图片生成的新图片）</span><br><span class="line">                $img_path &#x3D; $UPLOAD_ADDR.$newfilename;</span><br><span class="line">                unlink($target_path);</span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            $msg &#x3D; &quot;上传失败！&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $msg &#x3D; &quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="上传流程"><a href="#上传流程" class="headerlink" title="上传流程"></a>上传流程</h5><p>准备一张GIF图片</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408085942785.png" alt="image-20200408085942785"></p>
<p>先上传查看能否上传，成功上传</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090025138.png" alt="image-20200408090025138"></p>
<p>在命令行使用<code>copy picture/d+ shell.php 2.gif</code>来复制一张带有木马的图片，在进行上传</p>
<p>页面返回成功</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090025138.png" alt="image-20200408090025138"></p>
<p>打开二次渲染后的图片发现我们插入的<code>&lt;?php  phpinfo(); ?&gt;</code>消失了</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090541467.png" alt="image-20200408090541467"></p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090556017.png" alt="image-20200408090556017"></p>
<p>显然，这样的图片马上传方式失败了。<br> 不过二次渲染会保留一些文件内容不会改变，所以在制作图片马之前，我们先观察二次渲染前后图片不会改变的地方，将其代码写入其中即可绕过二次渲染</p>
<p>经过对比，蓝色区域是不会改变的，在其中写入了<code>&lt;?php phpinfo(); ?&gt;</code>保存，再次进行上传</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090816482.png" alt="image-20200408090816482"></p>
<p>页面返回正常</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408090859802.png" alt="image-20200408090859802"></p>
<p>打开图片查看是否有phpinfo()代码，查看是否被二次渲染掉，上传成功，并没有被渲染掉</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408091006941.png" alt="image-20200408091006941"></p>
<p>不知这一种方法，还有就是自己写一个小代码，里面包含简易提交和一句话木马，将写入的代码二次渲染到图片上去，这样上传后可以直接在页面中查看是否返回成功</p>
<p>在页面中查看是否能返回phpinfo的页面，成功返回</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408091502290.png" alt="image-20200408091502290"></p>
<h4 id="upload-labs第十七关"><a href="#upload-labs第十七关" class="headerlink" title="upload-labs第十七关"></a>upload-labs第十七关</h4><h5 id="查看提示-3"><a href="#查看提示-3" class="headerlink" title="查看提示"></a>查看提示</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408091704597.png" alt="image-20200408091704597"></p>
<h5 id="代码分析-14"><a href="#代码分析-14" class="headerlink" title="代码分析"></a>代码分析</h5><p>代码审计，使用了<code>unlink()</code>函数删除文件。</p>
<p>这里是条件竞争，先将文件上传到服务器，然后判断文件后缀是否在白名单里，如果在则重命名，否则删除，因此我们可以上传1.php只需要在它删除之前访问即可，可以利用burp的intruder模块不断上传，然后我们不断的访问刷新该地址即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#39;submit&#39;]))&#123;</span><br><span class="line">    $ext_arr &#x3D; array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);</span><br><span class="line">    $file_name &#x3D; $_FILES[&#39;upload_file&#39;][&#39;name&#39;];</span><br><span class="line">    $temp_file &#x3D; $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];</span><br><span class="line">    $file_ext &#x3D; substr($file_name,strrpos($file_name,&quot;.&quot;)+1);</span><br><span class="line">    $upload_file &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; . $file_name;</span><br><span class="line"></span><br><span class="line">    if(move_uploaded_file($temp_file, $upload_file))&#123;</span><br><span class="line">        if(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">             $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39;. rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br><span class="line">             rename($upload_file, $img_path);</span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line">             unlink($upload_file);</span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line">             $is_upload &#x3D; true;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $msg &#x3D; &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;</span><br><span class="line">            unlink($upload_file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $msg &#x3D; &#39;上传失败！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个php文本文件</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092257532.png" alt="image-20200408092257532"></p>
<p>上传使用burp抓包发送的intruder模块进行clear$</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092529967.png" alt="image-20200408092529967"></p>
<p>修改User-Agent将其Add$</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092612457.png" alt="image-20200408092612457"></p>
<p>设置payloads选择Number，执行次数1000次</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092657212.png" alt="image-20200408092657212"></p>
<p>点击start attack进行攻击</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408092758617.png" alt="image-20200408092758617"></p>
<p>攻击是在页面输入你之前上传的php文件名字，不断进行刷新</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408093537018.png" alt="image-20200408093537018"></p>
<h4 id="upload-labs第十八关"><a href="#upload-labs第十八关" class="headerlink" title="upload-labs第十八关"></a>upload-labs第十八关</h4><h5 id="查看提示-4"><a href="#查看提示-4" class="headerlink" title="查看提示"></a>查看提示</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408093707249.png" alt="image-20200408093707249"></p>
<h5 id="代码分析-15"><a href="#代码分析-15" class="headerlink" title="代码分析"></a>代码分析</h5><p>对文件后缀名做了白名单判断，然后检查文件大小、文件是否存在等等。 将文件上传后，对文件重新命名，同样存在条件竞争的漏洞。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;index.php</span><br><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;]))</span><br><span class="line">&#123;</span><br><span class="line">    require_once(&quot;.&#x2F;myupload.php&quot;);</span><br><span class="line">    $imgFileName &#x3D;time();</span><br><span class="line">    $u &#x3D; new MyUpload($_FILES[&#39;upload_file&#39;][&#39;name&#39;], $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $_FILES[&#39;upload_file&#39;][&#39;size&#39;],$imgFileName);</span><br><span class="line">    $status_code &#x3D; $u-&gt;upload($UPLOAD_ADDR);</span><br><span class="line">    switch ($status_code) &#123;</span><br><span class="line">        case 1:</span><br><span class="line">            $is_upload &#x3D; true;</span><br><span class="line">            $img_path &#x3D; $u-&gt;cls_upload_dir . $u-&gt;cls_file_rename_to;</span><br><span class="line">            break;</span><br><span class="line">        case 2:</span><br><span class="line">            $msg &#x3D; &#39;文件已经被上传，但没有重命名。&#39;;</span><br><span class="line">            break; </span><br><span class="line">        case -1:</span><br><span class="line">            $msg &#x3D; &#39;这个文件不能上传到服务器的临时文件存储目录。&#39;;</span><br><span class="line">            break; </span><br><span class="line">        case -2:</span><br><span class="line">            $msg &#x3D; &#39;上传失败，上传目录不可写。&#39;;</span><br><span class="line">            break; </span><br><span class="line">        case -3:</span><br><span class="line">            $msg &#x3D; &#39;上传失败，无法上传该类型文件。&#39;;</span><br><span class="line">            break; </span><br><span class="line">        case -4:</span><br><span class="line">            $msg &#x3D; &#39;上传失败，上传的文件过大。&#39;;</span><br><span class="line">            break; </span><br><span class="line">        case -5:</span><br><span class="line">            $msg &#x3D; &#39;上传失败，服务器已经存在相同名称文件。&#39;;</span><br><span class="line">            break; </span><br><span class="line">        case -6:</span><br><span class="line">            $msg &#x3D; &#39;文件无法上传，文件不能复制到目标目录。&#39;;</span><br><span class="line">            break;      </span><br><span class="line">        default:</span><br><span class="line">            $msg &#x3D; &#39;未知错误！&#39;;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;myupload.php</span><br><span class="line">class MyUpload&#123;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">  var $cls_arr_ext_accepted &#x3D; array(</span><br><span class="line">      &quot;.doc&quot;, &quot;.xls&quot;, &quot;.txt&quot;, &quot;.pdf&quot;, &quot;.gif&quot;, &quot;.jpg&quot;, &quot;.zip&quot;, &quot;.rar&quot;, &quot;.7z&quot;,&quot;.ppt&quot;,</span><br><span class="line">      &quot;.html&quot;, &quot;.xml&quot;, &quot;.tiff&quot;, &quot;.jpeg&quot;, &quot;.png&quot; );</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......  </span><br><span class="line">  &#x2F;** upload()</span><br><span class="line">   **</span><br><span class="line">   ** Method to upload the file.</span><br><span class="line">   ** This is the only method to call outside the class.</span><br><span class="line">   ** @para String name of directory we upload to</span><br><span class="line">   ** @returns void</span><br><span class="line">  **&#x2F;</span><br><span class="line">  function upload( $dir )&#123;</span><br><span class="line">    </span><br><span class="line">    $ret &#x3D; $this-&gt;isUploadedFile();</span><br><span class="line">    </span><br><span class="line">    if( $ret !&#x3D; 1 )&#123;</span><br><span class="line">      return $this-&gt;resultUpload( $ret );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ret &#x3D; $this-&gt;setDir( $dir );</span><br><span class="line">    if( $ret !&#x3D; 1 )&#123;</span><br><span class="line">      return $this-&gt;resultUpload( $ret );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ret &#x3D; $this-&gt;checkExtension();</span><br><span class="line">    if( $ret !&#x3D; 1 )&#123;</span><br><span class="line">      return $this-&gt;resultUpload( $ret );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ret &#x3D; $this-&gt;checkSize();</span><br><span class="line">    if( $ret !&#x3D; 1 )&#123;</span><br><span class="line">      return $this-&gt;resultUpload( $ret );    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; if flag to check if the file exists is set to 1</span><br><span class="line">    </span><br><span class="line">    if( $this-&gt;cls_file_exists &#x3D;&#x3D; 1 )&#123;</span><br><span class="line">      </span><br><span class="line">      $ret &#x3D; $this-&gt;checkFileExists();</span><br><span class="line">      if( $ret !&#x3D; 1 )&#123;</span><br><span class="line">        return $this-&gt;resultUpload( $ret );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; if we are here, we are ready to move the file to destination</span><br><span class="line"></span><br><span class="line">    $ret &#x3D; $this-&gt;move();</span><br><span class="line">    if( $ret !&#x3D; 1 )&#123;</span><br><span class="line">      return $this-&gt;resultUpload( $ret );    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; check if we need to rename the file</span><br><span class="line"></span><br><span class="line">    if( $this-&gt;cls_rename_file &#x3D;&#x3D; 1 )&#123;</span><br><span class="line">      $ret &#x3D; $this-&gt;renameFile();</span><br><span class="line">      if( $ret !&#x3D; 1 )&#123;</span><br><span class="line">        return $this-&gt;resultUpload( $ret );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; if we are here, everything worked as planned :)</span><br><span class="line"></span><br><span class="line">    return $this-&gt;resultUpload( &quot;SUCCESS&quot; );</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>页面代码显示补全在www目录下查看</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408094417117.png" alt="image-20200408094417117"></p>
<p>因此也存在条件竞争的问题，不过这题对文件后缀名做了白名单判断，然后会一步一步检查文件大小、文件是否存在等等，因此可以通过不断上传图片马，由于条件竞争可能来不及重命名，从而上传成功。</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408100032030.png" alt="image-20200408100032030"></p>
<h4 id="upload-labs第十九关"><a href="#upload-labs第十九关" class="headerlink" title="upload-labs第十九关"></a>upload-labs第十九关</h4><h5 id="查看提示-5"><a href="#查看提示-5" class="headerlink" title="查看提示"></a>查看提示</h5><p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408100802057.png" alt="image-20200408100802057"></p>
<h5 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h5><p>黑名单策略，文件名用户可控，文件命名<code>upload-19.php.</code>绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$is_upload &#x3D; false;</span><br><span class="line">$msg &#x3D; null;</span><br><span class="line">if (isset($_POST[&#39;submit&#39;])) &#123;</span><br><span class="line">    if (file_exists($UPLOAD_ADDR)) &#123;</span><br><span class="line">        $deny_ext &#x3D; array(&quot;php&quot;,&quot;php5&quot;,&quot;php4&quot;,&quot;php3&quot;,&quot;php2&quot;,&quot;html&quot;,&quot;htm&quot;,&quot;phtml&quot;,&quot;pht&quot;,&quot;jsp&quot;,&quot;jspa&quot;,&quot;jspx&quot;,&quot;jsw&quot;,&quot;jsv&quot;,&quot;jspf&quot;,&quot;jtml&quot;,&quot;asp&quot;,&quot;aspx&quot;,&quot;asa&quot;,&quot;asax&quot;,&quot;ascx&quot;,&quot;ashx&quot;,&quot;asmx&quot;,&quot;cer&quot;,&quot;swf&quot;,&quot;htaccess&quot;);</span><br><span class="line"></span><br><span class="line">        $file_name &#x3D; $_POST[&#39;save_name&#39;];</span><br><span class="line">        $file_ext &#x3D; pathinfo($file_name,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        if(!in_array($file_ext,$deny_ext)) &#123;</span><br><span class="line">            $img_path &#x3D; $UPLOAD_ADDR . &#39;&#x2F;&#39; .$file_name;</span><br><span class="line">            if (move_uploaded_file($_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $img_path)) &#123; </span><br><span class="line">                $is_upload &#x3D; true;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $msg &#x3D; &#39;上传失败！&#39;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $msg &#x3D; &#39;禁止保存为该类型文件！&#39;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; $UPLOAD_ADDR . &#39;文件夹不存在,请手工创建！&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>选择one.jpg这个可上传的文件，在保存名称处改为php文件名，不能直接改为one.php因为php是不可上传的文件，以上代码使用黑名单但是没有过滤” . “点等，所以利用Windows的特性直接在文件名后面加上一个” . “点，返回空白图片，复制图片地址</p>
<p>当然不止这一种情况，可以不使用“ . ”直接使用空格也是可以的，因为使用了黑名单但是没有过滤，所以有很多绕过绕过情况</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408101223834.png" alt="image-20200408101223834"></p>
<p>在新的页面打开并查看</p>
<p><img src="https://gitee.com/zhanqiaozai/picture/raw/master/image-20200408101414864.png" alt="image-20200408101414864"></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/04/07/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">文件上传</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="ds-share share" data-thread-key="upload-labs关卡" data-title="upload-labs关卡" data-url="https://zhanqiaozai.github.io/2020/04/08/upload-labs%E5%85%B3%E5%8D%A1/"  data-images="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" data-content="upload-labs关卡">
    <div class="ds-share-inline">
      <ul  class="ds-share-icons-16">
      	<li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
        <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
        <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
      </ul>
      <div class="ds-share-icons-more">
      </div>
    </div>
 </div>
 





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2020 zhanqiaozai
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>